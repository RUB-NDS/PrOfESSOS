<?xml version="1.0" encoding="UTF-8"?>
<TestPlan xmlns="http://nds.rub.de/oidc/test-model"
		  Name="OP-Test-Plan">

	<SuiteParameters>
		<Parameter Key="grant_not_needed">false</Parameter>
	</SuiteParameters>

	<LearningStep Name="LearningStep">
		<BrowserSimulator>
			<ImplementationClass>de.rub.nds.oidc.browser.op.OPLearningBrowser</ImplementationClass>
		</BrowserSimulator>
		<RPConfig-1>
			<ImplementationClass>de.rub.nds.oidc.server.rp.DefaultRP</ImplementationClass>
		</RPConfig-1>
		<RPConfig-2>
			<ImplementationClass>de.rub.nds.oidc.server.rp.DefaultRP</ImplementationClass>
		</RPConfig-2>
	</LearningStep>

	<TestStep Name="Authorization Code Reuse 1">
		<Description>PrOfESSOS attempts to redeem an authorization code that has already been used by another user of the same client</Description>
		<TestParameters>
			<Parameter Key="is_single_rp_test">true</Parameter>
		</TestParameters>
		<BrowserSimulator>
			<ImplementationClass>de.rub.nds.oidc.browser.op.OPCodeReuseBrowser</ImplementationClass>
		</BrowserSimulator>

        <RPConfig-1>
            <ImplementationClass>de.rub.nds.oidc.server.rp.CodeReuseRP</ImplementationClass>
            <Parameter Key="register_grant_types">authorization_code</Parameter>
            <Parameter Key="force_auth-code_reuse_user">true</Parameter>
        </RPConfig-1>
		<RPConfig-2>
			<!-- not used but required in config-->
			<ImplementationClass>de.rub.nds.oidc.server.rp.DefaultRP</ImplementationClass>
		</RPConfig-2>
	</TestStep>

	<TestStep Name="Authorization Code Reuse 2">
		<Description>PrOfESSOS attempts to redeem an authorization code that was issued to and has already been used by a different client - Honest RP</Description>
		<TestParameters>
			<Parameter Key="is_single_rp_test">false</Parameter>
		</TestParameters>
		<BrowserSimulator>
			<ImplementationClass>de.rub.nds.oidc.browser.op.OPCodeReuseBrowser</ImplementationClass>
		</BrowserSimulator>

        <RPConfig-1>
            <ImplementationClass>de.rub.nds.oidc.server.rp.CodeReuseRP</ImplementationClass>
            <Parameter Key="register_grant_types">authorization_code</Parameter>
            <Parameter Key="force-no-redeem-auth-code">false</Parameter>
        </RPConfig-1>
        <RPConfig-2>
            <ImplementationClass>de.rub.nds.oidc.server.rp.CodeReuseRP</ImplementationClass>
            <Parameter Key="register_grant_types">authorization_code</Parameter>
            <!--<Parameter Key="force-use-stored-auth-code">true</Parameter>-->
		</RPConfig-2>
	</TestStep>

    <TestStep Name="Authorization Code Reuse 3">
		<Description>PrOfESSOS attempts to redeem an authorization code that was issued to a different client but has not yet been used in a TokenRequest</Description>
		<TestParameters>
			<Parameter Key="is_single_rp_test">false</Parameter>
		</TestParameters>
		<BrowserSimulator>
			<ImplementationClass>de.rub.nds.oidc.browser.op.OPCodeReuseBrowser</ImplementationClass>
		</BrowserSimulator>

        <RPConfig-1>
            <ImplementationClass>de.rub.nds.oidc.server.rp.CodeReuseRP</ImplementationClass>
            <Parameter Key="register_grant_types">authorization_code</Parameter>
            <Parameter Key="force-no-redeem-auth-code">true</Parameter>
        </RPConfig-1>
        <RPConfig-2>
            <ImplementationClass>de.rub.nds.oidc.server.rp.CodeReuseRP</ImplementationClass>
            <Parameter Key="register_grant_types">authorization_code</Parameter>
            <!--<Parameter Key="force-use-stored-auth-code">true</Parameter>-->
		</RPConfig-2>
	</TestStep>

    <TestStep Name="Redirect URI Manipulation 1">
        <Description>PrOfESSOS issues an authentication request containing the <tt>redirect_uri</tt> value of another client - Evil Client</Description>
        <TestParameters>
            <Parameter Key="is_single_rp_test">false</Parameter>
        </TestParameters>
        <BrowserSimulator>
            <ImplementationClass>de.rub.nds.oidc.browser.op.OPRumBrowser</ImplementationClass>
        </BrowserSimulator>

        <RPConfig-1>
            <ImplementationClass>de.rub.nds.oidc.server.rp.RumRP</ImplementationClass>
            <Parameter Key="register_grant_types">authorization_code</Parameter>
            <Parameter Key="authnreq-force-evil-redirect-uri">true</Parameter>
        </RPConfig-1>
        <RPConfig-2>
            <ImplementationClass>de.rub.nds.oidc.server.rp.RumRP</ImplementationClass>
            <Parameter Key="register_grant_types">authorization_code</Parameter>
        </RPConfig-2>
    </TestStep>

    <TestStep Name="Code Hijack 1">
        <Description>PrOfESSOS issues a token request containing no redirect_uri parameter, even though one was present in the authentication request </Description>
        <TestParameters>
            <Parameter Key="is_single_rp_test">true</Parameter>
        </TestParameters>
        <BrowserSimulator>
            <ImplementationClass>de.rub.nds.oidc.browser.op.OPRumBrowser</ImplementationClass>
        </BrowserSimulator>

        <RPConfig-1>
            <ImplementationClass>de.rub.nds.oidc.server.rp.RumRP</ImplementationClass>
            <Parameter Key="register_grant_types">authorization_code</Parameter>
            <Parameter Key="tokenreq-force-empty-redirect-uri">true</Parameter>
        </RPConfig-1>
        <RPConfig-2>
            <!--not used in this test-->
            <ImplementationClass>de.rub.nds.oidc.server.rp.RumRP</ImplementationClass>
            <Parameter Key="register_grant_types">authorization_code</Parameter>
        </RPConfig-2>
    </TestStep>

    <TestStep Name="Code Hijack 2">
        <Description>PrOfESSOS issues a token request containing the <tt>redirect_uri</tt> value that does not match the one present in the authentication request </Description>
        <TestParameters>
            <Parameter Key="is_single_rp_test">true</Parameter>
        </TestParameters>
        <BrowserSimulator>
            <ImplementationClass>de.rub.nds.oidc.browser.op.OPRumBrowser</ImplementationClass>
        </BrowserSimulator>

        <RPConfig-1>
            <ImplementationClass>de.rub.nds.oidc.server.rp.RumRP</ImplementationClass>
            <Parameter Key="register_grant_types">authorization_code</Parameter>
            <Parameter Key="tokenreq-force-evil-redirect-uri">true</Parameter>
        </RPConfig-1>
        <RPConfig-2>
            <!--not used in this test-->
            <ImplementationClass>de.rub.nds.oidc.server.rp.RumRP</ImplementationClass>
            <Parameter Key="register_grant_types">authorization_code</Parameter>
        </RPConfig-2>
    </TestStep>

	<!--<TestStep Name="ID Spoofing 1">-->
		<!--<Description><![CDATA[-->
			<!--<h1>ID Spoofing Attack</h1>-->
			<!--In this test we use the Attacker OP and create an ID Token containing the identity (sub) of the victim,-->
			<!--which is controlled by another OP: Honest OP.-->

			<!--<h2>Prerequisites.</h2>-->
			<!--The target Client supports the implicit or the code flow. -->

			<!--<h2>Execution.</h2>-->
			<!--PrOfESSOS issues an invalid ID token containing the victim's identity in the "sub".-->

			<!--<h2>Result Evaluation.</h2>-->
			<!--The attack is successful if the Client accepts and ID Token AND logs the attacker into the victim's account.-->
			<!---->
			<!--<h2>Mitigation</h2>-->
			<!--The identity of an user is represented by the combination of "iss" -->
			<!--and "sub". Thus, both values MUST be used to authenticate the user.-->
		<!--]]>-->
		<!--</Description>-->
		<!--<TestParameters>-->
			<!--<Parameter Key="discovery_support_needed">false</Parameter>-->
			<!--<Parameter Key="dynamic_client_registration_support_needed">false</Parameter>-->
		<!--</TestParameters>-->
		<!--<BrowserSimulator>-->
			<!--<ImplementationClass>de.rub.nds.oidc.browser.DefaultRPTestBrowser</ImplementationClass>-->
			<!--<Parameter Key="use_evil_needle">false</Parameter>-->
		<!--</BrowserSimulator>-->
		<!--<OPConfig-1>-->
			<!--<ImplementationClass>de.rub.nds.oidc.server.op.DefaultOP</ImplementationClass>-->
		<!--</OPConfig-1>-->
		<!--<OPConfig-2>-->
			<!--<ImplementationClass>de.rub.nds.oidc.server.op.DefaultOP</ImplementationClass>-->

			<!--&lt;!&ndash; gets the "sub" configured in the Honest OP" &ndash;&gt;-->
			<!--<Parameter Key="force_honest_idtoken_iss">false</Parameter>-->
			<!--<Parameter Key="force_honest_idtoken_sub">true</Parameter>-->
			<!--<Parameter Key="force_honest_idtoken_name">false</Parameter>-->
			<!--<Parameter Key="force_honest_idtoken_username">false</Parameter>-->
			<!--<Parameter Key="force_honest_idtoken_email">false</Parameter>-->
		<!--</OPConfig-2>-->
	<!--</TestStep>-->

</TestPlan>
